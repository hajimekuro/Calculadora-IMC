<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calculadora IMC - Versión Corregida</title>

  <!-- Bootstrap CSS (para diseño rápido y badges) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome (iconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- =========================
       CSS personalizado
       ========================= -->
  <style>
    /* Variables de color y ajustes base */
    :root{
      --primary-color: #4a6bde;
      --muted-color: #6c757d;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light-bg: #f5f8ff;
      --card-bg: #fff;
    }

    /* Estilos globales */
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      margin: 0;
      padding: 2rem 1rem;
      color: #222;
    }

    /* Contenedor principal de la app */
    .app-container{
      max-width: 900px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 1.8rem;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .app-title{ text-align:center; color:var(--primary-color); margin-bottom:1rem; }

    /* Alternador de unidades */
    .unit-toggle{ display:flex; justify-content:center; margin-bottom:1.2rem; }

    /* Inputs y botones */
    .calculate-btn{
      background-color: var(--primary-color);
      color: white;
      border: none;
    }
    .calculate-btn:hover{ background-color:#3a56b5; }

    /* Tarjeta de resultados con variantes para categorías */
    .result-card{ padding: 1rem; border-radius: 10px; margin-top: 1rem; transition:all .25s ease; }
    .result-card.underweight{ background: rgba(23,162,184,0.12); border-left: 5px solid var(--info); }
    .result-card.normal{ background: rgba(40,167,69,0.10); border-left: 5px solid var(--success); }
    .result-card.overweight{ background: rgba(255,193,7,0.12); border-left: 5px solid var(--warning); }
    .result-card.obesity{ background: rgba(220,53,69,0.10); border-left: 5px solid var(--danger); }

    /* Tabla historial */
    .history-table{ margin-top: 1rem; max-height: 260px; overflow:auto; }

    /* Mensaje historial vacío */
    #emptyHistoryMessage{ margin-top: 0.6rem; }

    /* Ajustes responsivos menores */
    @media (max-width:576px){
      .app-container{ padding: 1rem; }
    }
  </style>
</head>
<body>

  <div class="app-container" role="main" aria-labelledby="appTitle">

    <h1 id="appTitle" class="app-title">Calculadora IMC</h1>

    <div class="unit-toggle" aria-hidden="false">
      <div class="btn-group" role="group" aria-label="Seleccion unidad">
        <input type="radio" class="btn-check" name="unit" id="metricUnit" value="metric" checked autocomplete="off">
        <label class="btn btn-outline-primary" for="metricUnit">Métrico</label>

        <input type="radio" class="btn-check" name="unit" id="imperialUnit" value="imperial" autocomplete="off">
        <label class="btn btn-outline-primary" for="imperialUnit">Imperial</label>
      </div>
    </div>

    <form id="bmiForm" class="bmi-form" novalidate>
      <div class="metric-inputs">
        <div class="mb-3">
          <label for="weightKg" class="form-label">Peso (kg)</label>
          <input type="number" class="form-control" id="weightKg" min="20" max="500" step="0.1" placeholder="ej. 70">
        </div>
        <div class="mb-3">
          <label for="heightCm" class="form-label">Altura (cm)</label>
          <input type="number" class="form-control" id="heightCm" min="50" max="300" step="0.1" placeholder="ej. 170">
        </div>
      </div>

      <div class="imperial-inputs d-none">
        <div class="mb-3">
          <label for="weightLbs" class="form-label">Peso (lbs)</label>
          <input type="number" class="form-control" id="weightLbs" min="40" max="1000" step="0.1" placeholder="ej. 154">
        </div>
        <div class="row">
          <div class="col mb-3">
            <label for="heightFt" class="form-label">Altura (pies)</label>
            <input type="number" class="form-control" id="heightFt" min="1" max="9" placeholder="ej. 5">
          </div>
          <div class="col mb-3">
            <label for="heightIn" class="form-label">Altura (pulgadas)</label>
            <input type="number" class="form-control" id="heightIn" min="0" max="11" placeholder="ej. 7">
          </div>
        </div>
      </div>

      <button type="button" id="calculateBtn" class="btn calculate-btn w-100" aria-label="Calcular IMC">
        <span id="calculateSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        &nbsp;Calcular IMC
      </button>
    </form>

    <div id="resultCard" class="result-card d-none" aria-live="polite">
      <div class="text-center">
        <div class="bmi-value display-5 fw-bold" id="bmiValue">0.0</div>
        <div id="bmiCategory" class="h5">-</div>
        <div id="bmiDate" class="text-muted small">-</div>
      </div>
      <p id="bmiDescription" class="mt-3 mb-0">-</p>
    </div>

    <div class="history-container">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="h5 mb-0">Historial</h3>
        <div>
          <button id="clearHistoryBtn" class="btn btn-sm btn-outline-secondary">Borrar Historial</button>
        </div>
      </div>

      <div class="history-table">
        <table class="table table-hover mb-0 mt-2">
          <thead class="table-light">
            <tr>
              <th>Fecha / Hora</th>
              <th>Unidad</th>
              <th>Peso</th>
              <th>Altura</th>
              <th>IMC</th>
              <th>Categoría</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
          </tbody>
        </table>
      </div>

      <p id="emptyHistoryMessage" class="text-center text-muted">Aún no hay historial. Calcula tu IMC para comenzar.</p>
    </div>

    <div class="text-center mt-3">
      <a href="#" id="startOverLink" class="text-decoration-none">Empezar nuevamente</a>
    </div>

    <div class="footer text-center mt-3 small text-muted">
      © 2025 Calculadora IMC. Todos los derechos reservados.
    </div>

  </div>

  <!-- Bootstrap Bundle JS (Popper incluido) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =========================
       SCRIPT PRINCIPAL (JavaScript)
       ========================= -->
  <script id="app-script">
    document.addEventListener('DOMContentLoaded', () => {
      const metricUnit = document.getElementById('metricUnit');
      const imperialUnit = document.getElementById('imperialUnit');
      const metricInputs = document.querySelector('.metric-inputs');
      const imperialInputs = document.querySelector('.imperial-inputs');
      const bmiForm = document.getElementById('bmiForm');
      const weightKg = document.getElementById('weightKg');
      const heightCm = document.getElementById('heightCm');
      const weightLbs = document.getElementById('weightLbs');
      const heightFt = document.getElementById('heightFt');
      const heightIn = document.getElementById('heightIn');
      const calculateBtn = document.getElementById('calculateBtn');
      const calculateSpinner = document.getElementById('calculateSpinner');
      const resultCard = document.getElementById('resultCard');
      const bmiValue = document.getElementById('bmiValue');
      const bmiCategory = document.getElementById('bmiCategory');
      const bmiDate = document.getElementById('bmiDate');
      const bmiDescription = document.getElementById('bmiDescription');
      const historyTableBody = document.getElementById('historyTableBody');
      const clearHistoryBtn = document.getElementById('clearHistoryBtn');
      const startOverLink = document.getElementById('startOverLink');
      const emptyHistoryMessage = document.getElementById('emptyHistoryMessage');

      const BMI_HISTORY_KEY = 'bmiHistory';

      metricUnit.addEventListener('change', () => {
        metricInputs.classList.remove('d-none');
        imperialInputs.classList.add('d-none');
      });

      imperialUnit.addEventListener('change', () => {
        imperialInputs.classList.remove('d-none');
        metricInputs.classList.add('d-none');
      });

      function calculateBMI(weight, height) {
        return weight / ((height / 100) ** 2);
      }

      function calculateImperialBMI(weight, ft, inch) {
        const heightInches = (ft * 12) + inch;
        return (weight * 703) / (heightInches ** 2);
      }

      function getBMICategory(bmi) {
        if (bmi < 18.5) {
          return { category: 'Bajo peso', class: 'underweight', description: 'Estás por debajo del peso recomendado. Considera asesoría médica.' };
        } else if (bmi >= 18.5 && bmi < 25) {
          return { category: 'Normal', class: 'normal', description: 'Tu IMC está dentro del rango saludable. Mantén hábitos activos y equilibrados.' };
        } else if (bmi >= 25 && bmi < 30) {
          return { category: 'Sobrepeso', class: 'overweight', description: 'Estás por encima del peso ideal. Evaluar dieta y actividad física.' };
        } else {
          return { category: 'Obesidad', class: 'obesity', description: 'Clasificado en obesidad. Se recomienda consulta médica especializada.' };
        }
      }

      function formatDate(date) {
        return new Intl.DateTimeFormat('es-ES', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        }).format(date);
      }

      function loadHistory() {
        const history = JSON.parse(localStorage.getItem(BMI_HISTORY_KEY)) || [];
        updateHistoryUI(history);
      }

      function saveHistory(history) {
        localStorage.setItem(BMI_HISTORY_KEY, JSON.stringify(history));
        updateHistoryUI(history);
      }

      function getBadgeClass(category) {
        switch (category) {
          case 'Bajo peso': return 'bg-info text-dark';
          case 'Normal': return 'bg-success';
          case 'Sobrepeso': return 'bg-warning text-dark';
          case 'Obesidad': return 'bg-danger';
          default: return 'bg-secondary';
        }
      }

      function updateHistoryUI(history) {
        historyTableBody.innerHTML = '';

        if (!history || history.length === 0) {
          emptyHistoryMessage.classList.remove('d-none');
          return;
        }
        emptyHistoryMessage.classList.add('d-none');

        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((record, index) => {
          const row = document.createElement('tr');

          row.innerHTML = `
            <td>${record.formattedDate}</td>
            <td>${record.unit}</td>
            <td>${record.weight} ${record.unit === 'Metric' ? 'kg' : 'lbs'}</td>
            <td>${record.height}</td>
            <td>${record.bmi.toFixed(1)}</td>
            <td><span class="badge ${getBadgeClass(record.category)}">${record.category}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}" aria-label="Eliminar registro">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;

          historyTableBody.appendChild(row);
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const idx = parseInt(this.getAttribute('data-index'));
            deleteHistoryItem(idx);
          });
        });
      }

      function deleteHistoryItem(index) {
        const history = JSON.parse(localStorage.getItem(BMI_HISTORY_KEY)) || [];
        if (index >= 0 && index < history.length) {
          history.splice(index, 1);
          saveHistory(history);
        }
      }

      /**
       * runCalculation
       * If called with the literal string 'save' we'll persist the valid result to history.
       * When called from input/change events no saving will occur.
       */
      function runCalculation(opt = null) {
        const isMetric = metricUnit.checked;

        if (isMetric) {
          if (!weightKg.value || !heightCm.value) return;
          if (isNaN(parseFloat(weightKg.value)) || isNaN(parseFloat(heightCm.value))) return;
        } else {
          if (!weightLbs.value || !heightFt.value || !heightIn.value) return;
          if (isNaN(parseFloat(weightLbs.value)) || isNaN(parseInt(heightFt.value)) || isNaN(parseInt(heightIn.value))) return;
        }

        let bmi, weightNumeric, heightDisplay, unitLabel;

        if (isMetric) {
          weightNumeric = parseFloat(weightKg.value);
          const h = parseFloat(heightCm.value);
          bmi = calculateBMI(weightNumeric, h);
          heightDisplay = `${h} cm`; // fixed: use template literal
          unitLabel = 'Metric';
        } else {
          weightNumeric = parseFloat(weightLbs.value);
          const ft = parseInt(heightFt.value);
          const inch = parseInt(heightIn.value);
          bmi = calculateImperialBMI(weightNumeric, ft, inch);
          heightDisplay = `${ft}'${inch}"`; // fixed: use template literal and include quotes properly
          unitLabel = 'Imperial';
        }

        const now = new Date();
        const formattedDate = formatDate(now);
        const bmiInfo = getBMICategory(bmi);

        bmiValue.textContent = bmi.toFixed(1);
        bmiCategory.textContent = bmiInfo.category;
        bmiDate.textContent = formattedDate;
        bmiDescription.textContent = bmiInfo.description;

        resultCard.className = 'result-card';
        resultCard.classList.add(bmiInfo.class);
        resultCard.classList.remove('d-none');

        // Save to history only when explicitly requested (we call runCalculation('save') on button clicks)
        const shouldSave = opt === 'save' || (opt && opt.type === 'click');
        if (shouldSave) {
          const history = JSON.parse(localStorage.getItem(BMI_HISTORY_KEY)) || [];
          history.push({
            date: now.toISOString(),
            formattedDate,
            unit: unitLabel,
            weight: weightNumeric,
            height: heightDisplay,
            bmi,
            category: bmiInfo.category
          });
          saveHistory(history);
          resultCard.scrollIntoView({ behavior: 'smooth' });
        }
      }

      // Click explicitly requests saving -> pass the 'save' flag
      calculateBtn.addEventListener('click', (e) => {
        runCalculation('save');
      });

      // Real-time updates (no save)
      [weightKg, heightCm, weightLbs, heightFt, heightIn, metricUnit, imperialUnit].forEach(el => {
        if (el.type === 'radio') {
          el.addEventListener('change', runCalculation);
        } else {
          el.addEventListener('input', () => runCalculation());
        }
      });

      bmiForm.addEventListener('submit', (e) => {
        e.preventDefault();
        runCalculation('save');
      });

      clearHistoryBtn.addEventListener('click', () => {
        if (confirm('¿Seguro que deseas borrar todo el historial?')) {
          localStorage.removeItem(BMI_HISTORY_KEY);
          loadHistory();
        }
      });

      startOverLink.addEventListener('click', (ev) => {
        ev.preventDefault();
        bmiForm.reset();
        resultCard.classList.add('d-none');
        metricUnit.checked = true;
        metricInputs.classList.remove('d-none');
        imperialInputs.classList.add('d-none');
      });

      loadHistory();
    });
  </script>
</body>
</html>
